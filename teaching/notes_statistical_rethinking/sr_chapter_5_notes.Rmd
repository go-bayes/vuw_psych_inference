---
title: "Statistical Rethinking | Chapter 5"
author: "Joseph Bulbulia"
date: "10/01/2021"

output:
  ioslides_presentation:
    incremental: no
   # mathjax: local
    self_contained: false
    widescreen: yes
    smaller: yes
    font_adjustment: -5
    css: extra.css
editor_options: 
    markdown: 
    wrap: 72
---


```{r global_options,  include = FALSE}
knitr::opts_chunk$set(message=FALSE, 
                      warning=FALSE,
                      collapse =TRUE,
                      echo=TRUE)
                      #results="hide", 
                     # fig.width = 10,
                     # fig.height=8)
# read libraries
```
```{r sourcelibraries, include=FALSE}
source("libs.R")
#source("funs.R") # custom functions for analysis
```

## Multiple regression, why? 

1. "control" i.e. confounding
2. complex causation (mediation)
3. interactions -- importance of one var depends on another var


## Load Data
```{r}
# load data and copy
library(rethinking)
data(WaffleDivorce)
d <- WaffleDivorce

# standardize variables
d$D <- standardize( d$Divorce )
d$M <- standardize( d$Marriage )
d$A <- standardize( d$MedianAgeMarriage )
```

## Single regressions

```{r cache = TRUE}
m5.1 <- quap(
  alist(
    D ~ dnorm( mu , sigma ) ,
    mu <- a + bA * A ,
    a ~ dnorm( 0 , 0.2 ) ,
    bA ~ dnorm( 0 , 0.5 ) ,
    sigma ~ dexp( 1 )
    ) , data = d )
precis(m5.1)
```


## Single regression with marriage rate


```{r cache =TRUE}
m5.2 <- quap(
  alist(
    D ~ dnorm( mu , sigma ) ,
    mu <- a + bM * M ,
    a ~ dnorm( 0 , 0.2 ) ,
    bM ~ dnorm( 0 , 0.5 ) ,
    sigma ~ dexp( 1 )
) , data = d )

precis(m5.2)
```

## Thinks before you regress!
Only one predictor has a causal effect.

```{r}
# possible dags
library(dagitty)
library(ggdag)
dagify(
  D  ~ A,
  M ~ A
) %>%
  ggdag() +
  theme_dag_blank()
```
 
## Another possible DAG

```{r}
dagify(D ~ A + M,
       M ~ A) %>% 
  ggdag() +
  theme_dag_blank()
```

## Implied conditional independence

```{r}
library(dagitty)
DMA_dag2 <- dagitty('dag{ D <- A -> M }')
impliedConditionalIndependencies( DMA_dag2 )
```

D $\perp$ M $|$ A


## Multiple regression

```{r}
m5.3 <- quap(
  alist(
    D ~ dnorm( mu , sigma ) ,
    mu <- a + bM*M + bA*A ,
    a ~ dnorm( 0 , 0.2 ) ,
    bM ~ dnorm( 0 , 0.5 ) ,
    bA ~ dnorm( 0 , 0.5 ) ,
    sigma ~ dexp( 1 )
    ) , data = d )
plot( coeftab(m5.1,m5.2, m5.3), par=c("bA","bM") )
```

## Simulate Divorce example

```{r cache = TRUE}
library(brms)
library(sjPlot)
N <- 500 # number of simulated States
age <- rnorm( N )# sim A
mar <- rnorm( N , -age ) # sim A -> M”
div <- rnorm( N ,  age ) # sim A -> D”
#create data frame
nd<-cbind(age,mar,div)
#run models in brms
b1<- brms::brm(div ~ age, data = nd)
b2 <- brms::brm(div ~ mar, data = nd)
b3 <- brms::brm(div ~ age + mar, data = nd)

bayesplot::mcmc_intervals(b3,pars = c("b_age", "b_mar"))
```

## Masked Relationships





